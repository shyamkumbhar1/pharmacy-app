name: Deploy to AWS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Safe Deploy to AWS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ubuntu
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            cd ~/pharmacy-app
            git pull
            
            cd Docker
            
            # Build new containers (old ones still running)
            echo "ğŸ—ï¸ Building new containers..."
            if ! docker-compose build; then
              echo "âŒ Build failed - keeping old containers running"
              exit 1
            fi
            
            # Only restart if build successful
            echo "âœ… Build successful - restarting containers"
            docker-compose up -d
            
            # Health check - wait for services
            echo "â³ Waiting for services to start..."
            sleep 10
            
            # Check backend health
            if curl -f http://localhost:8000/api/users > /dev/null 2>&1; then
              echo "âœ… Backend health check passed"
            else
              echo "âŒ Backend health check failed - rolling back"
              docker-compose restart
              exit 1
            fi
            
            # Check frontend health
            if curl -f http://localhost:3001 > /dev/null 2>&1; then
              echo "âœ… Frontend health check passed"
            else
              echo "âŒ Frontend health check failed - rolling back"
              docker-compose restart
              exit 1
            fi
            
            # Run migrations automatically
            echo "ğŸ“Š Running database migrations..."
            docker-compose exec -T backend-app php artisan migrate --force || echo "âš ï¸ Migration may have failed or already run"
            
            echo "âœ… Deployment successful - all services running"
