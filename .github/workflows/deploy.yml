name: Deploy to AWS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Safe Deploy to AWS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ubuntu
          key: ${{ secrets.AWS_SSH_KEY }}
          timeout: 30s
          command_timeout: 15m
          script: |
            set -e
            echo "üöÄ Starting deployment..."
            echo "‚è∞ $(date)"
            
            echo ""
            echo "üì• Step 1/6: Pulling latest code..."
            cd ~/pharmacy-app
            git pull || { echo "‚ùå Git pull failed"; exit 1; }
            echo "‚úÖ Code pulled successfully"
            
            echo ""
            echo "üì¶ Step 2/6: Checking Docker status..."
            cd Docker
            docker-compose ps
            
            echo ""
            echo "üèóÔ∏è Step 3/6: Building new containers (this may take 5-10 minutes)..."
            echo "‚è∞ Start time: $(date)"
            if ! timeout 600 docker-compose build --progress=plain; then
              echo "‚ùå Build failed or timed out - keeping old containers running"
              exit 1
            fi
            echo "‚è∞ Build complete: $(date)"
            echo "‚úÖ Build successful"
            
            echo ""
            echo "üöÄ Step 4/6: Restarting containers..."
            docker-compose up -d || { echo "‚ùå Failed to start containers"; exit 1; }
            echo "‚úÖ Containers restarted"
            
            echo ""
            echo "‚è≥ Step 5/6: Waiting for services to start..."
            sleep 5
            echo "‚úÖ Wait complete"
            
            echo ""
            echo "üîç Step 6/6: Running health checks..."
            # Check backend health with retry
            BACKEND_OK=false
            for i in {1..5}; do
              if curl -f -s --max-time 5 http://localhost:8000/api/users > /dev/null 2>&1; then
                echo "‚úÖ Backend health check passed (attempt $i)"
                BACKEND_OK=true
                break
              fi
              echo "‚è≥ Backend not ready yet, retrying... ($i/5)"
              sleep 3
            done
            
            if [ "$BACKEND_OK" = false ]; then
              echo "‚ùå Backend health check failed - rolling back"
              docker-compose restart
              exit 1
            fi
            
            # Check frontend health with retry
            FRONTEND_OK=false
            for i in {1..5}; do
              if curl -f -s --max-time 5 http://localhost:3001 > /dev/null 2>&1; then
                echo "‚úÖ Frontend health check passed (attempt $i)"
                FRONTEND_OK=true
                break
              fi
              echo "‚è≥ Frontend not ready yet, retrying... ($i/5)"
              sleep 3
            done
            
            if [ "$FRONTEND_OK" = false ]; then
              echo "‚ùå Frontend health check failed - rolling back"
              docker-compose restart
              exit 1
            fi
            
            echo ""
            echo "üìä Running database migrations..."
            docker-compose exec -T backend-app php artisan migrate --force || echo "‚ö†Ô∏è Migration may have failed or already run"
            
            echo ""
            echo "‚úÖ Deployment successful - all services running"
            echo "‚è∞ End time: $(date)"