name: Deploy to AWS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Safe Deploy to AWS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ubuntu
          key: ${{ secrets.AWS_SSH_KEY }}
          timeout: 30s
          command_timeout: 15m
          script: |
            set -e
            echo "üöÄ Starting deployment..."
            echo "‚è∞ $(date)"
            
            echo ""
            echo "üì• Step 1/6: Pulling latest code..."
            cd ~/pharmacy-app
            git pull || { echo "‚ùå Git pull failed"; exit 1; }
            echo "‚úÖ Code pulled successfully"
            
            echo ""
            echo "üì¶ Step 2/6: Checking Docker status..."
            cd Docker
            docker-compose ps
            
            echo ""
            echo "üèóÔ∏è Step 3/6: Building backend (fast, ~2 minutes)..."
            echo "‚è∞ Backend build start: $(date)"
            if ! timeout 300 docker-compose build backend-app backend-nginx backend-db --progress=plain; then
              echo "‚ùå Backend build failed or timed out - keeping old containers running"
              exit 1
            fi
            echo "‚è∞ Backend build complete: $(date)"
            echo "‚úÖ Backend build successful"
            
            echo ""
            echo "üîç Step 4/7: Quick frontend validation (fast, ~1-2 minutes)..."
            echo "‚è∞ Validation start: $(date)"
            cd ~/pharmacy-app/frontend
            
            # Quick validation - install dependencies
            if ! npm install --silent; then
              echo "‚ùå Frontend dependency installation failed"
              exit 1
            fi
            echo "‚úÖ Dependencies installed"
            
            # Quick build check (validate syntax and dependencies)
            if ! npm run build 2>&1 | tee /tmp/build.log | head -100; then
              echo "‚ùå Frontend build validation failed - checking logs..."
              tail -50 /tmp/build.log
              exit 1
            fi
            echo "‚è∞ Validation complete: $(date)"
            echo "‚úÖ Frontend validation passed"
            
            echo ""
            echo "üèóÔ∏è Step 5/7: Building frontend container (this may take 5-10 minutes)..."
            echo "‚è∞ Frontend build start: $(date)"
            cd ~/pharmacy-app/Docker
            if ! timeout 900 docker-compose build frontend --progress=plain; then
              echo "‚ùå Frontend build failed or timed out - keeping old containers running"
              exit 1
            fi
            echo "‚è∞ Frontend build complete: $(date)"
            echo "‚úÖ Frontend build successful"
            
            echo ""
            echo "üöÄ Step 6/7: Restarting containers..."
            docker-compose up -d || { echo "‚ùå Failed to start containers"; exit 1; }
            echo "‚úÖ Containers restarted"
            
            echo ""
            echo "‚è≥ Step 7/7: Waiting for services to start..."
            sleep 5
            echo "‚úÖ Wait complete"
            
            echo ""
            echo "üîç Running health checks..."
            # Check backend health with retry
            BACKEND_OK=false
            for i in {1..5}; do
              if curl -f -s --max-time 5 http://localhost:8000/api/users > /dev/null 2>&1; then
                echo "‚úÖ Backend health check passed (attempt $i)"
                BACKEND_OK=true
                break
              fi
              echo "‚è≥ Backend not ready yet, retrying... ($i/5)"
              sleep 3
            done
            
            if [ "$BACKEND_OK" = false ]; then
              echo "‚ùå Backend health check failed - rolling back"
              docker-compose restart
              exit 1
            fi
            
            # Check frontend health with retry
            FRONTEND_OK=false
            for i in {1..5}; do
              if curl -f -s --max-time 5 http://localhost:3001 > /dev/null 2>&1; then
                echo "‚úÖ Frontend health check passed (attempt $i)"
                FRONTEND_OK=true
                break
              fi
              echo "‚è≥ Frontend not ready yet, retrying... ($i/5)"
              sleep 3
            done
            
            if [ "$FRONTEND_OK" = false ]; then
              echo "‚ùå Frontend health check failed - rolling back"
              docker-compose restart
              exit 1
            fi
            
            echo ""
            echo "üìä Running database migrations..."
            docker-compose exec -T backend-app php artisan migrate --force || echo "‚ö†Ô∏è Migration may have failed or already run"
            
            echo ""
            echo "‚úÖ Deployment successful - all services running"
            echo "‚è∞ End time: $(date)"